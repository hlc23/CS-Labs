name: Package Labs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  package-labs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create build directory
      run: mkdir -p build

    - name: Package all labs
      run: |
        # Get list of changed directories (only package labs that have changes)
        if [ "${{ github.event_name }}" = "push" ]; then
          # Check if we have at least 2 commits (HEAD~1 exists)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            # For push events with previous commits, get changed directories from the commit
            CHANGED_DIRS=$(git diff --name-only HEAD~1 | xargs -n1 dirname | sort | uniq | grep -v "^\.$" | grep -v "^\.\." | grep -v "^build$" | grep -v "^\.github$")
          else
            # First commit or shallow clone, package all labs
            echo "No previous commit found, packaging all labs..."
            CHANGED_DIRS=$(find . -maxdepth 1 -type d -not -name "." -not -name ".." -not -name "build" -not -name ".github" | xargs -n1 basename)
          fi
        else
          # For manual triggers, package all labs
          CHANGED_DIRS=$(find . -maxdepth 1 -type d -not -name "." -not -name ".." -not -name "build" -not -name ".github" | xargs -n1 basename)
        fi
        
        echo "Changed directories to package: $CHANGED_DIRS"
        
        for dirname in $CHANGED_DIRS; do
          if [ -d "$dirname" ]; then
            echo "Zipping $dirname..."
            cd "$dirname"
            if zip -r "../build/${dirname}.zip" .; then
              echo "✓ Successfully zipped $dirname"
            else
              echo "✗ Failed to zip $dirname, skipping..."
            fi
            cd ..
          else
            echo "Directory $dirname not found, skipping..."
          fi
        done

    - name: Commit and push build folder
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add build/
        git commit -m "Add packaged lab zip files [skip ci]" || echo "No changes to commit"
        git push